load("@npm_bazel_typescript//:index.bzl", "ts_library")
load("@npm_angular_bazel//:index.bzl", "protractor_web_test", "protractor_web_test_suite")

ts_library(
    name = "e2e",
    testonly = 1,
    srcs = [
        "app.po.ts",
        "app.spec.ts",
    ],
    tsconfig = ":tsconfig.json",
    deps = [
        "@npm//@types",
        "@npm//protractor",
    ],
)

ts_library(
    name = "ts_on_prepare",
    testonly = 1,
    srcs = ["on-prepare.ts"],
    tsconfig = ":tsconfig.json",
    deps = [
        "@npm//@angular/bazel",
        "@npm//@types",
        "@npm//protractor",
    ],
)

protractor_web_test_suite(
    name = "devserver_test",
    configuration = "//:protractor.conf.js",
    data = [
        "@npm//@angular/bazel",
        "@npm//protractor",
    ],
    on_prepare = ":ts_on_prepare",
    server = "//src:devserver",
    deps = [":e2e"],
)

protractor_web_test_suite(
    name = "prodserver_test",
    configuration = "//:protractor.conf.js",
    data = [
        "@npm//@angular/bazel",
        "@npm//protractor",
    ],
    on_prepare = ":ts_on_prepare",
    server = "//src:prodserver",
    deps = [":e2e"],
)

# To run this protractor_web_test target locally on SauceLabs:
# 1) have SAUCE_USERNAME, SAUCE_ACCESS_KEY (and optionally a SAUCE_TUNNEL_IDENTIFIER) set in your environment
# 2) open a sauce connection with `./scripts/saucelabs/start-tunnel.sh`
#    NOTE: start-tunnel.sh uses `node_modules/sauce-connect` which is current linux specific:
#          "sauce-connect": "https://saucelabs.com/downloads/sc-4.5.3-linux.tar.gz".
#          On OSX or Windows you'll need to use the appropriate sauce-connect binary.
# 3) run target with `yarn bazel test --define=SAUCE_BROWSER=<browser> --config=saucelabs <target>`
#    where <browser> is one of the keys of sauceCapabilities in /integration/bazel/protractor-sauce.conf.js
#    such as SL_CHROMELEGACY.
#    NOTE: --config=saucelabs is required as it makes the SAUCE_XXX environment variables available to
#          the action. See /.bazelrc.
protractor_web_test(
    name = "prodserver_sauce_test",
    configuration = "//:protractor-sauce.conf.js",
    configuration_env_vars = ["SAUCE_BROWSER"],
    data = [
        "@npm//@angular/bazel",
        "@npm//protractor",
    ],
    on_prepare = ":ts_on_prepare",
    server = "//src:prodserver",
    tags = [
        "local",
        "manual",
        "saucelabs",
    ],
    deps = [":e2e"],
)
