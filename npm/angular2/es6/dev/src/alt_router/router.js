import { provide, ReflectiveInjector } from 'angular2/core';
import { isBlank, isPresent } from 'angular2/src/facade/lang';
import { ListWrapper } from 'angular2/src/facade/collection';
import { EventEmitter, PromiseWrapper, ObservableWrapper } from 'angular2/src/facade/async';
import { StringMapWrapper } from 'angular2/src/facade/collection';
import { BaseException } from 'angular2/src/facade/exceptions';
import { recognize } from './recognize';
import { link } from './link';
import { equalSegments, routeSegmentComponentFactory, RouteSegment, RouteTree, rootNode, TreeNode, UrlSegment } from './segments';
import { hasLifecycleHook } from './lifecycle_reflector';
import { DEFAULT_OUTLET_NAME } from './constants';
export class RouterOutletMap {
    constructor() {
        /** @internal */
        this._outlets = {};
    }
    registerOutlet(name, outlet) { this._outlets[name] = outlet; }
}
export class Router {
    constructor(_rootComponent, _rootComponentType, _componentResolver, _urlSerializer, _routerOutletMap, _location) {
        this._rootComponent = _rootComponent;
        this._rootComponentType = _rootComponentType;
        this._componentResolver = _componentResolver;
        this._urlSerializer = _urlSerializer;
        this._routerOutletMap = _routerOutletMap;
        this._location = _location;
        this._changes = new EventEmitter();
        this._prevTree = this._createInitialTree();
        this._setUpLocationChangeListener();
        this.navigateByUrl(this._location.path());
    }
    get urlTree() { return this._urlTree; }
    navigateByUrl(url) {
        return this._navigate(this._urlSerializer.parse(url));
    }
    navigate(changes, segment) {
        return this._navigate(this.createUrlTree(changes, segment));
    }
    dispose() { ObservableWrapper.dispose(this._locationSubscription); }
    _createInitialTree() {
        let root = new RouteSegment([new UrlSegment("", null, null)], null, DEFAULT_OUTLET_NAME, this._rootComponentType, null);
        return new RouteTree(new TreeNode(root, []));
    }
    _setUpLocationChangeListener() {
        this._locationSubscription = this._location.subscribe((change) => { this._navigate(this._urlSerializer.parse(change['url'])); });
    }
    _navigate(url) {
        this._urlTree = url;
        return recognize(this._componentResolver, this._rootComponentType, url)
            .then(currTree => {
            return new _LoadSegments(currTree, this._prevTree)
                .load(this._routerOutletMap, this._rootComponent)
                .then(updated => {
                if (updated) {
                    this._prevTree = currTree;
                    this._location.go(this._urlSerializer.serialize(this._urlTree));
                    this._changes.emit(null);
                }
            });
        });
    }
    createUrlTree(changes, segment) {
        if (isPresent(this._prevTree)) {
            let s = isPresent(segment) ? segment : this._prevTree.root;
            return link(s, this._prevTree, this.urlTree, changes);
        }
        else {
            return null;
        }
    }
    serializeUrl(url) { return this._urlSerializer.serialize(url); }
    get changes() { return this._changes; }
    get routeTree() { return this._prevTree; }
}
class _LoadSegments {
    constructor(currTree, prevTree) {
        this.currTree = currTree;
        this.prevTree = prevTree;
        this.deactivations = [];
        this.performMutation = true;
    }
    load(parentOutletMap, rootComponent) {
        let prevRoot = isPresent(this.prevTree) ? rootNode(this.prevTree) : null;
        let currRoot = rootNode(this.currTree);
        return this.canDeactivate(currRoot, prevRoot, parentOutletMap, rootComponent)
            .then(res => {
            this.performMutation = true;
            if (res) {
                this.loadChildSegments(currRoot, prevRoot, parentOutletMap, [rootComponent]);
            }
            return res;
        });
    }
    canDeactivate(currRoot, prevRoot, outletMap, rootComponent) {
        this.performMutation = false;
        this.loadChildSegments(currRoot, prevRoot, outletMap, [rootComponent]);
        let allPaths = PromiseWrapper.all(this.deactivations.map(r => this.checkCanDeactivatePath(r)));
        return allPaths.then((values) => values.filter(v => v).length === values.length);
    }
    checkCanDeactivatePath(path) {
        let curr = PromiseWrapper.resolve(true);
        for (let p of ListWrapper.reversed(path)) {
            curr = curr.then(_ => {
                if (hasLifecycleHook("routerCanDeactivate", p)) {
                    return p.routerCanDeactivate(this.prevTree, this.currTree);
                }
                else {
                    return _;
                }
            });
        }
        return curr;
    }
    loadChildSegments(currNode, prevNode, outletMap, components) {
        let prevChildren = isPresent(prevNode) ?
            prevNode.children.reduce((m, c) => {
                m[c.value.outlet] = c;
                return m;
            }, {}) :
            {};
        currNode.children.forEach(c => {
            this.loadSegments(c, prevChildren[c.value.outlet], outletMap, components);
            StringMapWrapper.delete(prevChildren, c.value.outlet);
        });
        StringMapWrapper.forEach(prevChildren, (v, k) => this.unloadOutlet(outletMap._outlets[k], components));
    }
    loadSegments(currNode, prevNode, parentOutletMap, components) {
        let curr = currNode.value;
        let prev = isPresent(prevNode) ? prevNode.value : null;
        let outlet = this.getOutlet(parentOutletMap, currNode.value);
        if (equalSegments(curr, prev)) {
            this.loadChildSegments(currNode, prevNode, outlet.outletMap, components.concat([outlet.loadedComponent]));
        }
        else {
            this.unloadOutlet(outlet, components);
            if (this.performMutation) {
                let outletMap = new RouterOutletMap();
                let loadedComponent = this.loadNewSegment(outletMap, curr, prev, outlet);
                this.loadChildSegments(currNode, prevNode, outletMap, components.concat([loadedComponent]));
            }
        }
    }
    loadNewSegment(outletMap, curr, prev, outlet) {
        let resolved = ReflectiveInjector.resolve([provide(RouterOutletMap, { useValue: outletMap }), provide(RouteSegment, { useValue: curr })]);
        let ref = outlet.load(routeSegmentComponentFactory(curr), resolved, outletMap);
        if (hasLifecycleHook("routerOnActivate", ref.instance)) {
            ref.instance.routerOnActivate(curr, prev, this.currTree, this.prevTree);
        }
        return ref.instance;
    }
    getOutlet(outletMap, segment) {
        let outlet = outletMap._outlets[segment.outlet];
        if (isBlank(outlet)) {
            if (segment.outlet == DEFAULT_OUTLET_NAME) {
                throw new BaseException(`Cannot find default outlet`);
            }
            else {
                throw new BaseException(`Cannot find the outlet ${segment.outlet}`);
            }
        }
        return outlet;
    }
    unloadOutlet(outlet, components) {
        if (isPresent(outlet) && outlet.isLoaded) {
            StringMapWrapper.forEach(outlet.outletMap._outlets, (v, k) => this.unloadOutlet(v, components));
            if (this.performMutation) {
                outlet.unload();
            }
            else {
                this.deactivations.push(components.concat([outlet.loadedComponent]));
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGlmZmluZ19wbHVnaW5fd3JhcHBlci1vdXRwdXRfcGF0aC1ndE03UWhFbi50bXAvYW5ndWxhcjIvc3JjL2FsdF9yb3V0ZXIvcm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUFPLEVBQVMsT0FBTyxFQUFFLGtCQUFrQixFQUFvQixNQUFNLGVBQWU7T0FFN0UsRUFBTyxPQUFPLEVBQUUsU0FBUyxFQUFDLE1BQU0sMEJBQTBCO09BQzFELEVBQUMsV0FBVyxFQUFDLE1BQU0sZ0NBQWdDO09BQ25ELEVBQ0wsWUFBWSxFQUVaLGNBQWMsRUFDZCxpQkFBaUIsRUFDbEIsTUFBTSwyQkFBMkI7T0FDM0IsRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLGdDQUFnQztPQUN4RCxFQUFDLGFBQWEsRUFBQyxNQUFNLGdDQUFnQztPQUdyRCxFQUFDLFNBQVMsRUFBQyxNQUFNLGFBQWE7T0FFOUIsRUFBQyxJQUFJLEVBQUMsTUFBTSxRQUFRO09BRXBCLEVBQ0wsYUFBYSxFQUNiLDRCQUE0QixFQUM1QixZQUFZLEVBRVosU0FBUyxFQUNULFFBQVEsRUFDUixRQUFRLEVBQ1IsVUFBVSxFQUVYLE1BQU0sWUFBWTtPQUNaLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSx1QkFBdUI7T0FDL0MsRUFBQyxtQkFBbUIsRUFBQyxNQUFNLGFBQWE7QUFFL0M7SUFBQTtRQUNFLGdCQUFnQjtRQUNoQixhQUFRLEdBQW1DLEVBQUUsQ0FBQztJQUVoRCxDQUFDO0lBREMsY0FBYyxDQUFDLElBQVksRUFBRSxNQUFvQixJQUFVLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUM1RixDQUFDO0FBRUQ7SUFNRSxZQUFvQixjQUFzQixFQUFVLGtCQUF3QixFQUN4RCxrQkFBcUMsRUFDckMsY0FBbUMsRUFDbkMsZ0JBQWlDLEVBQVUsU0FBbUI7UUFIOUQsbUJBQWMsR0FBZCxjQUFj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QUksQ0FBQyxDQUFDO2dCQUNOLE1BQU0sSUFBSSxhQUFhLENBQUMsMEJBQTBCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQ3RFLENBQUM7UUFDSCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRU8sWUFBWSxDQUFDLE1BQW9CLEVBQUUsVUFBb0I7UUFDN0QsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFDekIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDckUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNsQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkUsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtPbkluaXQsIHByb3ZpZGUsIFJlZmxlY3RpdmVJbmplY3RvciwgQ29tcG9uZW50UmVzb2x2ZXJ9IGZyb20gJ2FuZ3VsYXIyL2NvcmUnO1xuaW1wb3J0IHtSb3V0ZXJPdXRsZXR9IGZyb20gJy4vZGlyZWN0aXZlcy9yb3V0ZXJfb3V0bGV0JztcbmltcG9ydCB7VHlwZSwgaXNCbGFuaywgaXNQcmVzZW50fSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2xhbmcnO1xuaW1wb3J0IHtMaXN0V3JhcHBlcn0gZnJvbSAnYW5ndWxhcjIvc3JjL2ZhY2FkZS9jb2xsZWN0aW9uJztcbmltcG9ydCB7XG4gIEV2ZW50RW1pdHRlcixcbiAgT2JzZXJ2YWJsZSxcbiAgUHJvbWlzZVdyYXBwZXIsXG4gIE9ic2VydmFibGVXcmFwcGVyXG59IGZyb20gJ2FuZ3VsYXIyL3NyYy9mYWNhZGUvYXN5bmMnO1xuaW1wb3J0IHtTdHJpbmdNYXBXcmFwcGVyfSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHtCYXNlRXhjZXB0aW9ufSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2V4Y2VwdGlvbnMnO1xuaW1wb3J0IHtSb3V0ZXJVcmxTZXJpYWxpemVyfSBmcm9tICcuL3JvdXRlcl91cmxfc2VyaWFsaXplcic7XG5pbXBvcnQge0NhbkRlYWN0aXZhdGV9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge3JlY29nbml6ZX0gZnJvbSAnLi9yZWNvZ25pemUnO1xuaW1wb3J0IHtMb2NhdGlvbn0gZnJvbSAnYW5ndWxhcjIvcGxhdGZvcm0vY29tbW9uJztcbmltcG9ydCB7bGlua30gZnJvbSAnLi9saW5rJztcblxuaW1wb3J0IHtcbiAgZXF1YWxTZWdtZW50cyxcbiAgcm91dGVTZWdtZW50Q29tcG9uZW50RmFjdG9yeSxcbiAgUm91dGVTZWdtZW50LFxuICBVcmxUcmVlLFxuICBSb3V0ZVRyZWUsXG4gIHJvb3ROb2RlLFxuICBUcmVlTm9kZSxcbiAgVXJsU2VnbWVudCxcbiAgc2VyaWFsaXplUm91dGVTZWdtZW50VHJlZVxufSBmcm9tICcuL3NlZ21lbnRzJztcbmltcG9ydCB7aGFzTGlmZWN5Y2xlSG9va30gZnJvbSAnLi9saWZlY3ljbGVfcmVmbGVjdG9yJztcbmltcG9ydCB7REVGQVVMVF9PVVRMRVRfTkFNRX0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5leHBvcnQgY2xhc3MgUm91dGVyT3V0bGV0TWFwIHtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBfb3V0bGV0czoge1tuYW1lOiBzdHJpbmddOiBSb3V0ZXJPdXRsZXR9ID0ge307XG4gIHJlZ2lzdGVyT3V0bGV0KG5hbWU6IHN0cmluZywgb3V0bGV0OiBSb3V0ZXJPdXRsZXQpOiB2b2lkIHsgdGhpcy5fb3V0bGV0c1tuYW1lXSA9IG91dGxldDsgfVxufVxuXG5leHBvcnQgY2xhc3MgUm91dGVyIHtcbiAgcHJpdmF0ZSBfcHJldlRyZWU6IFJvdXRlVHJlZTtcbiAgcHJpdmF0ZSBfdXJsVHJlZTogVXJsVHJlZTtcbiAgcHJpdmF0ZSBfbG9jYXRpb25TdWJzY3JpcHRpb246IGFueTtcbiAgcHJpdmF0ZSBfY2hhbmdlczogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX3Jvb3RDb21wb25lbnQ6IE9iamVjdCwgcHJpdmF0ZSBfcm9vdENvbXBvbmVudFR5cGU6IFR5cGUsXG4gICAgICAgICAgICAgIHByaXZhdGUgX2NvbXBvbmVudFJlc29sdmVyOiBDb21wb25lbnRSZXNvbHZlcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfdXJsU2VyaWFsaXplcjogUm91dGVyVXJsU2VyaWFsaXplcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfcm91dGVyT3V0bGV0TWFwOiBSb3V0ZXJPdXRsZXRNYXAsIHByaXZhdGUgX2xvY2F0aW9uOiBMb2NhdGlvbikge1xuICAgIHRoaXMuX3ByZXZUcmVlID0gdGhpcy5fY3JlYXRlSW5pdGlhbFRyZWUoKTtcbiAgICB0aGlzLl9zZXRVcExvY2F0aW9uQ2hhbmdlTGlzdGVuZXIoKTtcbiAgICB0aGlzLm5hdmlnYXRlQnlVcmwodGhpcy5fbG9jYXRpb24ucGF0aCgpKTtcbiAgfVxuXG4gIGdldCB1cmxUcmVlKCk6IFVybFRyZWUgeyByZXR1cm4gdGhpcy5fdXJsVHJlZTsgfVxuXG4gIG5hdmlnYXRlQnlVcmwodXJsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5fbmF2aWdhdGUodGhpcy5fdXJsU2VyaWFsaXplci5wYXJzZSh1cmwpKTtcbiAgfVxuXG4gIG5hdmlnYXRlKGNoYW5nZXM6IGFueVtdLCBzZWdtZW50PzogUm91dGVTZWdtZW50KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX25hdmlnYXRlKHRoaXMuY3JlYXRlVXJsVHJlZShjaGFuZ2VzLCBzZWdtZW50KSk7XG4gIH1cblxuICBkaXNwb3NlKCk6IHZvaWQgeyBPYnNlcnZhYmxlV3JhcHBlci5kaXNwb3NlKHRoaXMuX2xvY2F0aW9uU3Vic2NyaXB0aW9uKTsgfVxuXG4gIHByaXZhdGUgX2NyZWF0ZUluaXRpYWxUcmVlKCk6IFJvdXRlVHJlZSB7XG4gICAgbGV0IHJvb3QgPSBuZXcgUm91dGVTZWdtZW50KFtuZXcgVXJsU2VnbWVudChcIlwiLCBudWxsLCBudWxsKV0sIG51bGwsIERFRkFVTFRfT1VUTEVUX05BTUUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jvb3RDb21wb25lbnRUeXBlLCBudWxsKTtcbiAgICByZXR1cm4gbmV3IFJvdXRlVHJlZShuZXcgVHJlZU5vZGU8Um91dGVTZWdtZW50Pihyb290LCBbXSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0VXBMb2NhdGlvbkNoYW5nZUxpc3RlbmVyKCk6IHZvaWQge1xuICAgIHRoaXMuX2xvY2F0aW9uU3Vic2NyaXB0aW9uID0gdGhpcy5fbG9jYXRpb24uc3Vic2NyaWJlKFxuICAgICAgICAoY2hhbmdlKSA9PiB7IHRoaXMuX25hdmlnYXRlKHRoaXMuX3VybFNlcmlhbGl6ZXIucGFyc2UoY2hhbmdlWyd1cmwnXSkpOyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX25hdmlnYXRlKHVybDogVXJsVHJlZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuX3VybFRyZWUgPSB1cmw7XG4gICAgcmV0dXJuIHJlY29nbml6ZSh0aGlzLl9jb21wb25lbnRSZXNvbHZlciwgdGhpcy5fcm9vdENvbXBvbmVudFR5cGUsIHVybClcbiAgICAgICAgLnRoZW4oY3VyclRyZWUgPT4ge1xuICAgICAgICAgIHJldHVybiBuZXcgX0xvYWRTZWdtZW50cyhjdXJyVHJlZSwgdGhpcy5fcHJldlRyZWUpXG4gICAgICAgICAgICAgIC5sb2FkKHRoaXMuX3JvdXRlck91dGxldE1hcCwgdGhpcy5fcm9vdENvbXBvbmVudClcbiAgICAgICAgICAgICAgLnRoZW4odXBkYXRlZCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3ByZXZUcmVlID0gY3VyclRyZWU7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9sb2NhdGlvbi5nbyh0aGlzLl91cmxTZXJpYWxpemVyLnNlcmlhbGl6ZSh0aGlzLl91cmxUcmVlKSk7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VzLmVtaXQobnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gIH1cblxuICBjcmVhdGVVcmxUcmVlKGNoYW5nZXM6IGFueVtdLCBzZWdtZW50PzogUm91dGVTZWdtZW50KTogVXJsVHJlZSB7XG4gICAgaWYgKGlzUHJlc2VudCh0aGlzLl9wcmV2VHJlZSkpIHtcbiAgICAgIGxldCBzID0gaXNQcmVzZW50KHNlZ21lbnQpID8gc2VnbWVudCA6IHRoaXMuX3ByZXZUcmVlLnJvb3Q7XG4gICAgICByZXR1cm4gbGluayhzLCB0aGlzLl9wcmV2VHJlZSwgdGhpcy51cmxUcmVlLCBjaGFuZ2VzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgc2VyaWFsaXplVXJsKHVybDogVXJsVHJlZSk6IHN0cmluZyB7IHJldHVybiB0aGlzLl91cmxTZXJpYWxpemVyLnNlcmlhbGl6ZSh1cmwpOyB9XG5cbiAgZ2V0IGNoYW5nZXMoKTogT2JzZXJ2YWJsZTx2b2lkPiB7IHJldHVybiB0aGlzLl9jaGFuZ2VzOyB9XG5cbiAgZ2V0IHJvdXRlVHJlZSgpOiBSb3V0ZVRyZWUgeyByZXR1cm4gdGhpcy5fcHJldlRyZWU7IH1cbn1cblxuXG5jbGFzcyBfTG9hZFNlZ21lbnRzIHtcbiAgcHJpdmF0ZSBkZWFjdGl2YXRpb25zOiBPYmplY3RbXVtdID0gW107XG4gIHByaXZhdGUgcGVyZm9ybU11dGF0aW9uOiBib29sZWFuID0gdHJ1ZTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGN1cnJUcmVlOiBSb3V0ZVRyZWUsIHByaXZhdGUgcHJldlRyZWU6IFJvdXRlVHJlZSkge31cblxuICBsb2FkKHBhcmVudE91dGxldE1hcDogUm91dGVyT3V0bGV0TWFwLCByb290Q29tcG9uZW50OiBPYmplY3QpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsZXQgcHJldlJvb3QgPSBpc1ByZXNlbnQodGhpcy5wcmV2VHJlZSkgPyByb290Tm9kZSh0aGlzLnByZXZUcmVlKSA6IG51bGw7XG4gICAgbGV0IGN1cnJSb290ID0gcm9vdE5vZGUodGhpcy5jdXJyVHJlZSk7XG5cbiAgICByZXR1cm4gdGhpcy5jYW5EZWFjdGl2YXRlKGN1cnJSb290LCBwcmV2Um9vdCwgcGFyZW50T3V0bGV0TWFwLCByb290Q29tcG9uZW50KVxuICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgIHRoaXMucGVyZm9ybU11dGF0aW9uID0gdHJ1ZTtcbiAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICB0aGlzLmxvYWRDaGlsZFNlZ21lbnRzKGN1cnJSb290LCBwcmV2Um9vdCwgcGFyZW50T3V0bGV0TWFwLCBbcm9vdENvbXBvbmVudF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2FuRGVhY3RpdmF0ZShjdXJyUm9vdDogVHJlZU5vZGU8Um91dGVTZWdtZW50PiwgcHJldlJvb3Q6IFRyZWVOb2RlPFJvdXRlU2VnbWVudD4sXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXRsZXRNYXA6IFJvdXRlck91dGxldE1hcCwgcm9vdENvbXBvbmVudDogT2JqZWN0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdGhpcy5wZXJmb3JtTXV0YXRpb24gPSBmYWxzZTtcbiAgICB0aGlzLmxvYWRDaGlsZFNlZ21lbnRzKGN1cnJSb290LCBwcmV2Um9vdCwgb3V0bGV0TWFwLCBbcm9vdENvbXBvbmVudF0pO1xuXG4gICAgbGV0IGFsbFBhdGhzID0gUHJvbWlzZVdyYXBwZXIuYWxsKHRoaXMuZGVhY3RpdmF0aW9ucy5tYXAociA9PiB0aGlzLmNoZWNrQ2FuRGVhY3RpdmF0ZVBhdGgocikpKTtcbiAgICByZXR1cm4gYWxsUGF0aHMudGhlbigodmFsdWVzOiBib29sZWFuW10pID0+IHZhbHVlcy5maWx0ZXIodiA9PiB2KS5sZW5ndGggPT09IHZhbHVlcy5sZW5ndGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0NhbkRlYWN0aXZhdGVQYXRoKHBhdGg6IE9iamVjdFtdKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgbGV0IGN1cnIgPSBQcm9taXNlV3JhcHBlci5yZXNvbHZlKHRydWUpO1xuICAgIGZvciAobGV0IHAgb2YgTGlzdFdyYXBwZXIucmV2ZXJzZWQocGF0aCkpIHtcbiAgICAgIGN1cnIgPSBjdXJyLnRoZW4oXyA9PiB7XG4gICAgICAgIGlmIChoYXNMaWZlY3ljbGVIb29rKFwicm91dGVyQ2FuRGVhY3RpdmF0ZVwiLCBwKSkge1xuICAgICAgICAgIHJldHVybiAoPENhbkRlYWN0aXZhdGU+cCkucm91dGVyQ2FuRGVhY3RpdmF0ZSh0aGlzLnByZXZUcmVlLCB0aGlzLmN1cnJUcmVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gXztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjdXJyO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkQ2hpbGRTZWdtZW50cyhjdXJyTm9kZTogVHJlZU5vZGU8Um91dGVTZWdtZW50PiwgcHJldk5vZGU6IFRyZWVOb2RlPFJvdXRlU2VnbWVudD4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGV0TWFwOiBSb3V0ZXJPdXRsZXRNYXAsIGNvbXBvbmVudHM6IE9iamVjdFtdKTogdm9pZCB7XG4gICAgbGV0IHByZXZDaGlsZHJlbiA9IGlzUHJlc2VudChwcmV2Tm9kZSkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldk5vZGUuY2hpbGRyZW4ucmVkdWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChtLCBjKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtW2MudmFsdWUub3V0bGV0XSA9IGM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt9KSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICB7fTtcblxuICAgIGN1cnJOb2RlLmNoaWxkcmVuLmZvckVhY2goYyA9PiB7XG4gICAgICB0aGlzLmxvYWRTZWdtZW50cyhjLCBwcmV2Q2hpbGRyZW5bYy52YWx1ZS5vdXRsZXRdLCBvdXRsZXRNYXAsIGNvbXBvbmVudHMpO1xuICAgICAgU3RyaW5nTWFwV3JhcHBlci5kZWxldGUocHJldkNoaWxkcmVuLCBjLnZhbHVlLm91dGxldCk7XG4gICAgfSk7XG5cbiAgICBTdHJpbmdNYXBXcmFwcGVyLmZvckVhY2gocHJldkNoaWxkcmVuLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodiwgaykgPT4gdGhpcy51bmxvYWRPdXRsZXQob3V0bGV0TWFwLl9vdXRsZXRzW2tdLCBjb21wb25lbnRzKSk7XG4gIH1cblxuICBsb2FkU2VnbWVudHMoY3Vyck5vZGU6IFRyZWVOb2RlPFJvdXRlU2VnbWVudD4sIHByZXZOb2RlOiBUcmVlTm9kZTxSb3V0ZVNlZ21lbnQ+LFxuICAgICAgICAgICAgICAgcGFyZW50T3V0bGV0TWFwOiBSb3V0ZXJPdXRsZXRNYXAsIGNvbXBvbmVudHM6IE9iamVjdFtdKTogdm9pZCB7XG4gICAgbGV0IGN1cnIgPSBjdXJyTm9kZS52YWx1ZTtcbiAgICBsZXQgcHJldiA9IGlzUHJlc2VudChwcmV2Tm9kZSkgPyBwcmV2Tm9kZS52YWx1ZSA6IG51bGw7XG4gICAgbGV0IG91dGxldCA9IHRoaXMuZ2V0T3V0bGV0KHBhcmVudE91dGxldE1hcCwgY3Vyck5vZGUudmFsdWUpO1xuXG4gICAgaWYgKGVxdWFsU2VnbWVudHMoY3VyciwgcHJldikpIHtcbiAgICAgIHRoaXMubG9hZENoaWxkU2VnbWVudHMoY3Vyck5vZGUsIHByZXZOb2RlLCBvdXRsZXQub3V0bGV0TWFwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRzLmNvbmNhdChbb3V0bGV0LmxvYWRlZENvbXBvbmVudF0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51bmxvYWRPdXRsZXQob3V0bGV0LCBjb21wb25lbnRzKTtcbiAgICAgIGlmICh0aGlzLnBlcmZvcm1NdXRhdGlvbikge1xuICAgICAgICBsZXQgb3V0bGV0TWFwID0gbmV3IFJvdXRlck91dGxldE1hcCgpO1xuICAgICAgICBsZXQgbG9hZGVkQ29tcG9uZW50ID0gdGhpcy5sb2FkTmV3U2VnbWVudChvdXRsZXRNYXAsIGN1cnIsIHByZXYsIG91dGxldCk7XG4gICAgICAgIHRoaXMubG9hZENoaWxkU2VnbWVudHMoY3Vyck5vZGUsIHByZXZOb2RlLCBvdXRsZXRNYXAsIGNvbXBvbmVudHMuY29uY2F0KFtsb2FkZWRDb21wb25lbnRdKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBsb2FkTmV3U2VnbWVudChvdXRsZXRNYXA6IFJvdXRlck91dGxldE1hcCwgY3VycjogUm91dGVTZWdtZW50LCBwcmV2OiBSb3V0ZVNlZ21lbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGV0OiBSb3V0ZXJPdXRsZXQpOiBPYmplY3Qge1xuICAgIGxldCByZXNvbHZlZCA9IFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlKFxuICAgICAgICBbcHJvdmlkZShSb3V0ZXJPdXRsZXRNYXAsIHt1c2VWYWx1ZTogb3V0bGV0TWFwfSksIHByb3ZpZGUoUm91dGVTZWdtZW50LCB7dXNlVmFsdWU6IGN1cnJ9KV0pO1xuICAgIGxldCByZWYgPSBvdXRsZXQubG9hZChyb3V0ZVNlZ21lbnRDb21wb25lbnRGYWN0b3J5KGN1cnIpLCByZXNvbHZlZCwgb3V0bGV0TWFwKTtcbiAgICBpZiAoaGFzTGlmZWN5Y2xlSG9vayhcInJvdXRlck9uQWN0aXZhdGVcIiwgcmVmLmluc3RhbmNlKSkge1xuICAgICAgcmVmLmluc3RhbmNlLnJvdXRlck9uQWN0aXZhdGUoY3VyciwgcHJldiwgdGhpcy5jdXJyVHJlZSwgdGhpcy5wcmV2VHJlZSk7XG4gICAgfVxuICAgIHJldHVybiByZWYuaW5zdGFuY2U7XG4gIH1cblxuICBwcml2YXRlIGdldE91dGxldChvdXRsZXRNYXA6IFJvdXRlck91dGxldE1hcCwgc2VnbWVudDogUm91dGVTZWdtZW50KTogUm91dGVyT3V0bGV0IHtcbiAgICBsZXQgb3V0bGV0ID0gb3V0bGV0TWFwLl9vdXRsZXRzW3NlZ21lbnQub3V0bGV0XTtcbiAgICBpZiAoaXNCbGFuayhvdXRsZXQpKSB7XG4gICAgICBpZiAoc2VnbWVudC5vdXRsZXQgPT0gREVGQVVMVF9PVVRMRVRfTkFNRSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFzZUV4Y2VwdGlvbihgQ2Fubm90IGZpbmQgZGVmYXVsdCBvdXRsZXRgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBCYXNlRXhjZXB0aW9uKGBDYW5ub3QgZmluZCB0aGUgb3V0bGV0ICR7c2VnbWVudC5vdXRsZXR9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvdXRsZXQ7XG4gIH1cblxuICBwcml2YXRlIHVubG9hZE91dGxldChvdXRsZXQ6IFJvdXRlck91dGxldCwgY29tcG9uZW50czogT2JqZWN0W10pOiB2b2lkIHtcbiAgICBpZiAoaXNQcmVzZW50KG91dGxldCkgJiYgb3V0bGV0LmlzTG9hZGVkKSB7XG4gICAgICBTdHJpbmdNYXBXcmFwcGVyLmZvckVhY2gob3V0bGV0Lm91dGxldE1hcC5fb3V0bGV0cyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodiwgaykgPT4gdGhpcy51bmxvYWRPdXRsZXQodiwgY29tcG9uZW50cykpO1xuICAgICAgaWYgKHRoaXMucGVyZm9ybU11dGF0aW9uKSB7XG4gICAgICAgIG91dGxldC51bmxvYWQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZGVhY3RpdmF0aW9ucy5wdXNoKGNvbXBvbmVudHMuY29uY2F0KFtvdXRsZXQubG9hZGVkQ29tcG9uZW50XSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufSJdfQ==